name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v0.2.0). Must already exist."
        required: true
        type: string

# Default to read-only; jobs escalate as needed.
permissions:
  contents: read

concurrency:
  group: release-${{ github.event.inputs.tag || github.ref_name }}
  cancel-in-progress: false   # Never cancel a release in progress

env:
  RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}

jobs:
  release:
    name: GoReleaser
    runs-on: ubuntu-latest
    permissions:
      contents: write      # Create GitHub release & upload assets
      packages: write      # Push container images to GHCR
      id-token: write      # OIDC for attestation
      attestations: write  # GitHub artifact attestations
    outputs:
      image: ${{ steps.image-ref.outputs.image }}
      digest: ${{ steps.image-ref.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Required for GoReleaser changelog and tag history
          ref: ${{ env.RELEASE_TAG }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        id: goreleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ env.RELEASE_TAG }}

      - name: Extract image reference
        id: image-ref
        run: |
          # Parse the actual image name and digest from GoReleaser artifacts JSON.
          # This avoids hardcoding the registry path which may differ from what Ko publishes.
          ARTIFACTS='${{ steps.goreleaser.outputs.artifacts }}'

          # Get the Docker Manifest entry (multi-arch index produced by Ko)
          MANIFEST_NAME=$(echo "${ARTIFACTS}" | jq -r '[.[] | select(.type=="Docker Manifest")][0].name // empty')
          DIGEST=$(echo "${ARTIFACTS}" | jq -r '[.[] | select(.type=="Docker Manifest")][0].extra.Digest // empty')

          if [ -z "${MANIFEST_NAME}" ]; then
            # Fallback to Docker Image if no manifest index
            MANIFEST_NAME=$(echo "${ARTIFACTS}" | jq -r '[.[] | select(.type=="Docker Image")][0].name // empty')
            DIGEST=$(echo "${ARTIFACTS}" | jq -r '[.[] | select(.type=="Docker Image")][0].extra.Digest // empty')
          fi

          # MANIFEST_NAME looks like "ghcr.io/terrpan/scaleset@sha256:abc..."
          # Extract just the repository (everything before @)
          REPO="${MANIFEST_NAME%%@*}"

          # For Trivy and display, use the tag-based reference
          IMAGE="${REPO}:${{ env.RELEASE_TAG }}"

          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"
          echo "repo=${REPO}" >> "$GITHUB_OUTPUT"
          echo "Image: ${IMAGE}"
          echo "Digest: ${DIGEST}"
          echo "Repo: ${REPO}"

      - name: Attest build provenance
        if: steps.image-ref.outputs.digest != ''
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ steps.image-ref.outputs.repo }}
          subject-digest: ${{ steps.image-ref.outputs.digest }}
          push-to-registry: true

  # ---------------------------------------------------------------------------
  # Vulnerability Scan â€” scans the released image with Trivy
  # ---------------------------------------------------------------------------
  vulnerability-scan:
    name: Vulnerability Scan
    needs: release
    runs-on: ubuntu-latest
    if: needs.release.outputs.image != ''
    permissions:
      contents: read
      packages: read
      security-events: write   # Upload SARIF to Security tab
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: ${{ needs.release.outputs.image }}
          format: json
          output: trivy-results.json
          severity: CRITICAL,HIGH,MEDIUM

      - name: Trivy SARIF report
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: ${{ needs.release.outputs.image }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH,MEDIUM

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
          category: trivy-release

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report-${{ env.RELEASE_TAG }}
          path: |
            trivy-results.json
            trivy-results.sarif
          retention-days: 90
