name: Build

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

# Default to read-only; jobs escalate as needed.
permissions:
  contents: read

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  KO_DOCKER_REPO: ghcr.io/${{ github.repository }}

jobs:
  build:
    name: Build & Push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write      # push to GHCR
      id-token: write      # OIDC signing / attestation
      attestations: write  # GitHub artifact attestations
    outputs:
      image: ${{ steps.build.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Setup Ko
        uses: ko-build/setup-ko@v0.9

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # On PRs we build but don't push; on main/tags we push.
      - name: Build image (PR — no push)
        if: github.event_name == 'pull_request'
        id: build-pr
        run: |
          image=$(ko build ./cmd/scaleset --push=false --base-import-paths --tarball=image.tar)
          echo "image=${image}" >> "$GITHUB_OUTPUT"

      - name: Build & push image
        if: github.event_name != 'pull_request'
        id: build
        run: |
          # Determine tags
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            image=$(ko build ./cmd/scaleset \
              --base-import-paths \
              --tags="${TAG},latest" \
              --sbom=cyclonedx \
              --image-refs=image-refs.txt)
          else
            SHA="${{ github.sha }}"
            image=$(ko build ./cmd/scaleset \
              --base-import-paths \
              --tags="${SHA:0:7}" \
              --sbom=cyclonedx \
              --image-refs=image-refs.txt)
          fi

          # Extract digest from the fully-qualified image ref
          digest=$(echo "${image}" | awk -F'@' '{print $2}')
          echo "image=${image}" >> "$GITHUB_OUTPUT"
          echo "digest=${digest}" >> "$GITHUB_OUTPUT"

      - name: Attest build provenance
        if: github.event_name != 'pull_request'
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ghcr.io/${{ github.repository }}/scaleset
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

  # ---------------------------------------------------------------------------
  # Vulnerability Scan — scans the built image with Trivy and uploads results
  # Ko embeds a CycloneDX SBOM directly in the image (--sbom=cyclonedx), so
  # no separate SBOM generation job is needed.
  # ---------------------------------------------------------------------------
  vulnerability-scan:
    name: Vulnerability Scan
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: read
      security-events: write  # upload SARIF to Security tab
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: ${{ needs.build.outputs.image }}
          format: json
          output: trivy-results.json
          severity: CRITICAL,HIGH,MEDIUM

      - name: Trivy SARIF report
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: ${{ needs.build.outputs.image }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH,MEDIUM

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
          category: trivy-container

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report
          path: |
            trivy-results.json
            trivy-results.sarif
          retention-days: 90
